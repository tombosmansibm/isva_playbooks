---
- name: Create reverse proxy
  hosts: all
  gather_facts: no
  tasks:
    - name: "Prepare policy server"
      import_role:
        name: ibm.isam.web.configure_policyserver

    - name: "Create reverse proxy (listen on port 444 at {{ ansible_host }}"
      import_role:
        name: ibm.isam.web.create_reverseproxy_instances

    - name: "Configure reverse proxy (listen on port 444 at {{ ansible_host }}"
      import_role:
        name: ibm.isam.web.configure_reverseproxy_instances

    # must flush handlers before restart
    - name: Meta flush handlers
      ansible.builtin.meta: flush_handlers

    # restart reverse proxies - not through handler !
    - name: Restart reverse proxies
      ansible.builtin.import_role:
        name: ibm.isam.web.restart_reverseproxy_instances

    - name: Configure junctions
      import_role:
        name: ibm.isam.web.configure_reverseproxy_junctions